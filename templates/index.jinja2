<!doctype html>
<head>
    <title>UpLily</title>
    <link href="css/semantic.min.css" rel="stylesheet">

    <script src="js/semantic.min.js"></script>
</head>

<script type="text/javascript">
    function uploadFile(file, s3Data, url) {
        console.log("Uploading to "+s3Data.url)
        var xhr = new XMLHttpRequest();

        xhr.open("POST", s3Data.url);

        var postData = new FormData();
        for (key in s3Data.fields) {
            postData.append(key, s3Data.fields[key]);
        }
        postData.append('file', file);

        xhr.onreadystatechange = function () {

            if (xhr.readyState === 4) {
                console.log(xhr.responseText)

                if (xhr.status === 200 || xhr.status === 204) {

                } else if (xhr.status === 302 || xhr.status === 307) {
                    // Newly created S3 buckets will respond with a 30x redirect for their first couple hours of
                    // existence. This seems to be due to backend DNS processes trailing the bucket creation.
                    // Follow the redirect
                    console.log("Got redirect response ("+xhr.status+") following to "+xhr.getResponseHeader("Location"))
                    s3Data.url = xhr.getResponseHeader("Location")
                    uploadFile(file, s3Data, url)
                } else {
                    alert("Could not upload file.");
                }
            }
        };

        xhr.send(postData);
    }

    function getSignedRequest(file) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/sign_s3?file_name=" + file.name + "&file_type=" + file.type);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    uploadFile(file, response.data, response.url);
                }
                else {
                    alert("Could not get signed URL.");
                }
            }
        };
        xhr.send();
    }

</script>

<h2 class="ui header">UpLily file upload catcher</h2>

A tiny server for uploading and downloading files over HTTP. Can run locally or on cloud services. <br>

{% if message_ok is defined and message_ok is not none and message_ok|length %}
<div class="ui positive message">
  <i class="close icon"></i>
  <div class="header">
    {{ message_ok }}
  </div>
</div>
{%endif %}

{% if message_err is defined and message_err is not none and message_err|length %}

<div class="ui negative message">
  <i class="close icon"></i>
  <div class="header">
    {{ message_err }}
  </div>
</div>

{%endif %}

<br>

<h3 style="color: darkgreen">Upload file from this page:</h3>
<form action="/ul/?browser_upload=True"
      method="post"
      enctype="multipart/form-data">
    Step 1) Select a file: <input type="file" name="file"/>
    <br>
    <br>
    Step 2) Upload file: <input type="submit" value="Upload Now">
</form>

<br><br>

<h3 style="color: darkgreen">Example of uploading file "local/testfile.txt" to UpLily on command line with curl</h3>
<pre>
    curl -X POST -F 'file=@./local/testfile.txt' {{ my_server }}ul/
</pre>

<br>

<h3 style="color: darkorange">Available files to download:</h3>

{% if uploaded_files_list.keys()|length > 0 %}
    {% for key, value in uploaded_files_list.items() %}
        <li><a href="{{ value["download_url"] }}">{{ key }}</a> ({{ value["locale"] }}, size: {{ value["file_size_in_bytes"] }} Bytes, MD5: {{ value["md5_hash"]}})</li>
    {% endfor %}
{% else %}
    <i>No files uploaded yet</i>
{% endif %}

<br>
<br>
<h3 style="color: slategrey"> UpLily project is on GitHub, Webpage is owned by UNITY/Raj</a>.</h3>

<script>
        (function () {
        document.getElementById("file_input").onchange = function () {
            var files = document.getElementById("file_input").files;
            var file = files[0];
            if (!file) {
                return alert("No file selected.");
            }
            getSignedRequest(file);
        };
    })();

</script>